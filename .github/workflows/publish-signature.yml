name: Verify and Publish Signature

on:
  push:
    branches:
      - main
    paths:
      - 'commits/signatures/**'

jobs:
  verify-and-publish:
    name: Verificar e Publicar Assinatura
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v3

      - name: Importar chave p√∫blica GPG do autor
        run: |
          gpg --import .github/workflows/gpg.key

          KEY_ID=$(gpg --list-keys --with-colons | grep '^pub' | cut -d':' -f5)

          echo "Setting trust level to ultimate for key: $KEY_ID"

          echo "$KEY_ID:6:" | gpg --import-ownertrust
        continue-on-error: false

      - name: Validar estrutura de diret√≥rios
        run: |
          echo "üìÅ Verificando estrutura em commits/signatures..."
          if [ ! -d "commits/signatures" ]; then
            echo "‚ùå Pasta commits/signatures n√£o encontrada!"
            exit 1
          fi

      - name: Exibir assinatura do √∫ltimo commit
        run: git log -1 --show-signature

      - name: Verificar arquivos de assinatura
        run: |
          echo "üîç Validando arquivos de assinatura..."
          find commits/signatures -type f -name "*.txt" | while read file; do
            echo "‚úîÔ∏è Validando $file"
            grep -q "DOCUMENT ID" "$file" || { echo "‚ùå Falta DOCUMENT ID em $file"; exit 1; }
            grep -q "USER ID" "$file" || { echo "‚ùå Falta USER ID em $file"; exit 1; }
            grep -q "HASH" "$file" || { echo "‚ùå Falta HASH em $file"; exit 1; }
            grep -q "SIGNED AT" "$file" || { echo "‚ùå Falta SIGNED AT em $file"; exit 1; }
          done

      - name: Verificar commits assinados (GPG ou SSH)
        run: |
          echo "üîê Verificando se os commits s√£o assinados..."
          UNSIGNED=$(git log -1 --pretty=format:"%G?" | grep -v "G")
          if [ -n "$UNSIGNED" ]; then
            echo "‚ùå O √∫ltimo commit n√£o est√° assinado! Commits devem ser assinados com GPG ou SSH."
            exit 1
          fi
          echo "‚úÖ Commit assinado corretamente."

      - name: Log dos √∫ltimos commits (auditoria)
        run: |
          echo "üìú Log dos √∫ltimos 5 commits:"
          git log -n 5 --pretty=format:"üî∏ %h | %an | %G? | %s" --abbrev-commit

      - name: Conclus√£o
        run: echo "‚úÖ Workflow finalizado com sucesso!"
