name: Verify and Publish Signature

on:
  push:
    branches:
      - main
    paths:
      - 'commits/signatures/**'

jobs:
  verify-and-publish:
    name: Verificar e Publicar Assinatura
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v3

      - name: Validar estrutura de diretÃ³rios
        run: |
          echo "ğŸ“ Verificando estrutura em commits/signatures..."
          if [ ! -d "commits/signatures" ]; then
            echo "âŒ Pasta commits/signatures nÃ£o encontrada!"
            exit 1
          fi

      - name: Verificar arquivos de assinatura
        run: |
          echo "ğŸ” Validando arquivos de assinatura..."
          find commits/signatures -type f -name "*.txt" | while read file; do
            echo "âœ”ï¸ Validando $file"
            grep -q "DOCUMENT ID" "$file" || { echo "âŒ Falta DOCUMENT ID em $file"; exit 1; }
            grep -q "USER ID" "$file" || { echo "âŒ Falta USER ID em $file"; exit 1; }
            grep -q "HASH" "$file" || { echo "âŒ Falta HASH em $file"; exit 1; }
            grep -q "SIGNED AT" "$file" || { echo "âŒ Falta SIGNED AT em $file"; exit 1; }
          done

      - name: Verificar commits assinados (GPG ou SSH)
        run: |
          echo "ğŸ” Verificando se os commits sÃ£o assinados..."
          UNSIGNED=$(git log -1 --pretty=format:"%G?" | grep -v "G")
          if [ -n "$UNSIGNED" ]; then
            echo "âŒ O Ãºltimo commit nÃ£o estÃ¡ assinado! Commits devem ser assinados com GPG ou SSH."
            exit 1
          fi
          echo "âœ… Commit assinado corretamente."

      - name: Log dos Ãºltimos commits (auditoria)
        run: |
          echo "ğŸ“œ Log dos Ãºltimos 5 commits:"
          git log -n 5 --pretty=format:"ğŸ”¸ %h | %an | %G? | %s" --abbrev-commit

      - name: ConclusÃ£o
        run: echo "âœ… Workflow finalizado com sucesso!"